#!/bin/bash
# Fetch unresolved review threads for a GitHub PR
# Usage: gh-unresolved-threads <PR_URL or PR_NUMBER>
set -euo pipefail

INPUT="${1:?Usage: gh-unresolved-threads <PR_URL or PR_NUMBER>}"

if [[ "$INPUT" =~ ^[0-9]+$ ]]; then
  if ! NWOSTR="$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null)"; then
    echo "Error: カレントディレクトリがGitHubリポジトリではないか、gh認証が未設定です" >&2
    exit 1
  fi
  OWNER="${NWOSTR%/*}"
  REPO="${NWOSTR#*/}"
  NUMBER="$INPUT"
elif [[ "$INPUT" =~ github\.com/([^/]+)/([^/]+)/pull/([0-9]+) ]]; then
  OWNER="${BASH_REMATCH[1]}"
  REPO="${BASH_REMATCH[2]}"
  NUMBER="${BASH_REMATCH[3]}"
else
  echo "Error: PR URLまたはPR番号(数字)を指定してください: $INPUT" >&2
  exit 1
fi

gh api graphql \
  -f owner="$OWNER" \
  -f repo="$REPO" \
  -F number="$NUMBER" \
  -f query='
    query($owner:String!,$repo:String!,$number:Int!){
      repository(owner:$owner,name:$repo){
        pullRequest(number:$number){
          reviewThreads(first:100){
            nodes{
              id
              isResolved
              comments(first:100){
                nodes{ author{login} body path line }
              }
            }
          }
        }
      }
    }' \
  --jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved==false)]'
